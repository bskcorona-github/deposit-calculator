# 原状回復費用 自動計算ツール

賃貸物件の退去時における原状回復費用を、国交省ガイドラインと契約書の特約に基づいて自動的に借主・貸主に振り分けるWebアプリケーションです。

## 主な機能

- **多形式ファイル対応**: 見積書（PDF/Excel/Word/CSV）、契約書（PDF/Word）を自動解析
- **ドラッグ&ドロップ**: 直感的なファイルアップロードUI
- **完全自動化**: 
  - 📄 **見積書から自動抽出**: 場所・数量・単価・単位・備考を自動認識
  - 🚬 **喫煙・ペット自動判定**: 備考から「喫煙によるヤニ汚れ」「ペットによる傷」を自動検出
  - ⚡ **手動入力不要**: チェックボックス入力が不要に
- **自動振り分け**: ガイドラインと特約に基づき、各費用項目を借主/貸主に自動配分
- **AI判定検証（自動）**: 振り分け時に自動的にAIが検証・修正
  - **公式ガイドライン準拠**: 国交省ガイドラインとQ&Aを最優先で参照
  - **判例情報**: 実際の裁判例に基づく判断
  - **自動修正**: 重大な問題と警告レベルの問題を自動的に修正
  - **透明性**: 修正理由を根拠バッジで明示
- **詳細情報表示**: 場所・数量・単価・単位を結果テーブルとCSVに表示
- **減価償却計算**: クロス・床・設備等に対して耐用年数に応じた減価償却を適用
- **特約100%負担対応**: 特約で全額負担と明記されている場合、減価償却を除外
- **根拠表示**: 各判断の根拠（ガイドライン原則、特約条項、減価計算）をバッジで明示
- **CSV/PDFエクスポート**: 計算結果を交渉用資料としてダウンロード可能
- **個人情報保護**: AI処理前に自動的にPIIをマスキング

## 技術スタック

- **フロントエンド**: Next.js 14 (App Router), React, TypeScript
- **スタイリング**: Tailwind CSS, shadcn/ui, lucide-react
- **ファイル解析**: 
  - PDF: pdf-parse
  - Excel: xlsx
  - Word: mammoth
- **AI統合**: OpenAI API
  - **モデル**: gpt-4o（最新の高性能モデル）
  - **用途**: 見積書解析、契約書解析、判定検証
  - **Structured Output**: 高精度なJSON抽出
- **ルールエンジン**: YAML設定 + カスタムロジック
- **テスト**: Vitest, React Testing Library

## セットアップ

### 必要な環境

- Node.js 18以上
- npm または yarn

### インストール

```bash
# 依存関係のインストール
npm install

# 環境変数の設定
cp .env.example .env
# .envファイルを編集してOPENAI_API_KEYを設定
```

### 開発サーバーの起動

```bash
npm run dev
```

http://localhost:3000 でアプリケーションが起動します。

### ビルド

```bash
npm run build
npm start
```

## 使い方

### 1. ファイルアップロード

**見積書（複数形式対応）**:
- PDF - テキストベースのPDF
- Excel - .xlsx、.xlsファイル
- Word - .docxファイル（AIによる解析）
- CSV - カンマ区切りファイル

**契約書**:
- PDF - テキストベースのPDF
- Word - .docxファイル（AIによる解析）

**アップロード方法**:
- ドラッグ&ドロップ
- エリアクリックでファイル選択
- ボタンからファイル選択

### 2. 内容確認

- 自動抽出された見積明細を確認
- 契約書の条項・特約を確認
- 必要に応じて手動で修正

### 3. 入居条件入力

- **入居年数**（必須）
- **建物築年数**（任意）

💡 **喫煙・ペット情報は自動判定されます**
見積書の備考や項目名から自動的に検出するため、手動入力は不要です。

### 4. 自動振り分け + AI検証を実行

- ボタンをクリックして費用を自動配分
- **AI検証が自動的に実行されます**（30秒程度）
  - 国交省ガイドライン準拠のチェック
  - 重大な問題は自動的に修正
  - 警告事項を表示
- 結果を確認（借主/貸主の負担額、根拠、AI検証結果）

### 5. エクスポート

- CSV形式でダウンロード
- 交渉資料として使用

## ルールのカスタマイズ

`lib/rules/defaultRules.yaml` を編集することで、判定ルールをカスタマイズできます。

主な設定項目:
- `default_allocation`: デフォルトの負担者（landlord/tenant）
- `tenant_if`: 借主負担となる条件
- `override_if`: 特約による上書き条件
- `depreciation.useful_life_years`: 耐用年数
- `pricing_guidance`: 価格の相場上限

## テスト

```bash
npm test
```

主要なテスト:
- 減価償却計算のロジック検証
- ルールエンジンの振り分け判定
- 個人情報マスキング機能

## デプロイ

### Vercelへのデプロイ

```bash
# Vercel CLIのインストール
npm i -g vercel

# デプロイ
vercel
```

環境変数 `OPENAI_API_KEY` をVercelのプロジェクト設定で追加してください。

## 注意事項

⚠️ **本ツールは参考情報を提供するものであり、法律助言ではありません。**

- 最終的な費用負担の判断は、当事者間の協議または専門家（弁護士等）への相談を推奨します
- ガイドラインは原則であり、個別事情により判断が異なる場合があります
- 特約の有効性判定は簡易的なものです

## ライセンス

MIT License

## 開発者向け情報

### ディレクトリ構成

```
app/                  # Next.js App Router
  api/               # APIルート
  page.tsx           # メインページ
components/          # Reactコンポーネント
  ui/               # shadcn/uiコンポーネント
lib/                 # ビジネスロジック
  ai/               # OpenAI統合
  pdf/              # PDF解析
  rules/            # ルールエンジン
  utils/            # ユーティリティ
```

### 主要なファイル

- `lib/rules/rulesEngine.ts`: 費用振り分けのコアロジック
- `lib/rules/defaultRules.yaml`: 判定ルールの定義
- `lib/rules/depreciation.ts`: 減価償却計算
- `lib/pdf/estimateExtractor.ts`: 見積PDF解析
- `lib/pdf/leaseExtractor.ts`: 契約書PDF解析
- `lib/ai/client.ts`: OpenAI APIクライアント

### カスタマイズポイント

1. **ルール追加**: `defaultRules.yaml`に新しいルールを追加
2. **カテゴリ追加**: 見積解析時のカテゴリ分類を拡張
3. **特約判定**: 特約の有効性チェックロジックを強化
4. **PDF解析**: より複雑なレイアウトに対応

## サポート

問題が発生した場合は、GitHubのIssueで報告してください。
